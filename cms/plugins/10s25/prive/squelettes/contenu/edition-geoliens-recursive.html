#CACHE{0}
<BOUCLE_rub(RUBRIQUES){id_rubrique}{tout}>

	<BOUCLE_can(CONDITION)
		{si
			#AUTORISER{modifier,rubrique,#ID_RUBRIQUE}
			|ou{#AUTORISER{creer,rubrique,#ID_RUBRIQUE}}
			|ou{#AUTORISER{creersitedans,rubrique,#ID_RUBRIQUE}}
		}>
		<div>
			<div style="border-bottom: thin solid #ccc; padding-bottom: .5em; margin-left: -.5em; padding-left: .5em; display: flex; align-items: center; gap: .5em;">
				<h#NIVEAU_REC style="flex: 1;">#TITRE</h#NIVEAU_REC>

				[(#AUTORISER{modifier,rubrique,#ID_RUBRIQUE}|oui)
					[(#NIVEAU_REC|>{1}|oui)<button type="button" data-dlg="dlg-rub-#ID_RUBRIQUE" title="Renommer #TITRE">Renommer</button>]
					<dialog id="dlg-rub-#ID_RUBRIQUE">
						<form style="display:grid;grid-template-columns: max-content 1fr; gap: 0.5em; align-items: center;"
									action="[(#URL_ACTION_AUTEUR{maj_geolieu,#ID_RUBRIQUE,#SELF})]"
									method="post">
							<label>Nom du lieu</label>
							<input type="text" name="nom_lieu" value="#TITRE">

							<!-- pour les bouton on fais un div flex sur les 2 column puis on les met a50% -->
							<div style="grid-column: span 2; display:flex; gap: 0.5em">
								<button class="close-all-dlg" type="button" value="Annuler" style="flex: 1;">Annuler</button>
								<button type="submit" value="Enregistrer" style="flex: 1;">Enregistrer</button>
							</div>
						</form>
					</dialog>
				]

				[(#AUTORISER{creer,rubrique,#ID_RUBRIQUE}|oui)
					<button type="button" data-dlg="dlg-ajoutsrub-#ID_RUBRIQUE" title="Ajouter une sous-rubrique dans #TITRE">+ rubrique</button>
					<dialog id="dlg-ajoutsrub-#ID_RUBRIQUE">
						<form style="display:grid;grid-template-columns: max-content 1fr; gap: 0.5em; align-items: center;"
									action="[(#URL_ACTION_AUTEUR{ajt_geolieu,#ID_RUBRIQUE,#SELF})]"
									method="post">

							<label>Nom du lieu</label>
							<input type="text" name="nom_lieu" value="">

							<!-- pour les bouton on fais un div flex sur les 2 column puis on les met a50% -->
							<div style="grid-column: span 2; display:flex; gap: 0.5em">
								<button class="close-all-dlg" type="button" value="Annuler" style="flex: 1;">Annuler</button>
								<button type="submit" value="Enregistrer" style="flex: 1;">Enregistrer</button>
							</div>
						</form>
					</dialog>
				]

				[(#AUTORISER{creersitedans,rubrique,#ID_RUBRIQUE}|oui)
					<button type="button" data-dlg="dlg-ajout-lien-#ID_RUBRIQUE" title="Ajouter un site dans #TITRE">+ site</button>
					<dialog id="dlg-ajout-lien-#ID_RUBRIQUE" style="width: 800px;">
						<form style="display:grid;grid-template-columns: max-content 1fr; gap: 0.5em; align-items: center;"
									action="[(#URL_ACTION_AUTEUR{ajt_geolien,#ID_RUBRIQUE,#SELF})]"
									method="post">
							<label>Type de site</label>
							<select name="typesite_site">
								<option value="">Pas de type !</option>
								<BOUCLE_groupmot_typesite_ajout(MOTS){id_groupe=4}{par titre}>
									<option value="#ID_MOT">#TITRE</option>
								</BOUCLE_groupmot_typesite_ajout>
							</select>

							<label>Nom du site</label>
							<input type="text" name="nom_site" value="">

							<label>URL du site</label>
							<input type="url" name="url_site" value="">

							<label>Territoire</label>
							<select name="territoire_site">
								<option value="">Pas de territoire !</option>
								<BOUCLE_groupmot_territoire_ajout(MOTS){id_groupe=2}{par titre}>
									<option value="#ID_MOT">#TITRE</option>
								</BOUCLE_groupmot_territoire_ajout>
							</select>

							<div class="coords-ui">
								<div class="geo-wrap" style="grid-column: span 2;">
									<!-- Carte à gauche -->
									<div id="map-ajout-site-#ID_RUBRIQUE"
											class="leaflet-map"
											data-lat=""
											data-lon="">
									</div>

									<!-- Panneau recherche à droite (lié à la bonne carte via data-map) -->
									<div class="geo-panel" data-map="map-ajout-site-#ID_RUBRIQUE">
										<div class="geo-searchbar" style="display:flex; gap:.5em; margin-bottom:.5rem">
											<input class="geo-search" data-map="map-ajout-site-#ID_RUBRIQUE" value="[(#TITRE|attribut_html)]"
														type="search" placeholder="Rechercher une adresse ou un lieu…" style="flex:1">
											<!--button class="geo-clear" data-map="map-site-#ID_SYNDIC" type="button" aria-label="Effacer">✖</button-->
										</div>

										<div class="geo-results" data-map="map-ajout-site-#ID_RUBRIQUE" hidden></div>

										<small style="margin-top:.5rem; color:#666">
											Clique sur la carte, déplace le marqueur ou utilise la recherche.
										</small>
									</div>
								</div>

								<label>Latitude</label>
								<input type="text" name="lat_site" value="">

								<label>Longitude</label>
								<input type="text" name="long_site" value="">
							</div>
							[(#REM) pour les bouton on fait un div flex sur les 2 column puis on les met a 50% ]
							<div style="grid-column: span 2; display:flex; gap: 0.5em">
								<button class="close-all-dlg" type="button" value="Annuler" style="flex: 1;">Annuler</button>
								<button type="submit" value="Enregistrer" style="flex: 1;">Enregistrer</button>
							</div>
						</form>
					</dialog>
				]
			</div>

			<div style="border-left:thin solid #ccc;padding:.5em 0 0 .5em;margin-left:.5em;display: flex;flex-direction: column;gap: .5em;">
				<B_sites>
					<table style="border-collapse:collapse;width:100%;background-color: #ccc;">
						<thead>
							<tr>
								<th style="padding: 0.2em;text-align:right">Type</th>
								<th style="padding: 0.2em;text-align:left">Nom du site</th>
								<th style="padding: 0.2em;text-align:left">URL du site</th>
								<th style="padding: 0.2em;text-align:left">Description</th>
								<th style="padding: 0.2em;text-align:left">Territoire</th>
								<th style="padding: 0.2em;text-align:center">Actions</th>
							</tr>
						</thead>
						<tbody style="font-size: .8em;">
							<BOUCLE_sites(SITES){id_rubrique}{statut IN publie,prop,refuse}{par num nom_site, nom_site}>
								[(#SET{lat,			 #DESCRIPTIF*|explode{','}|table_valeur{0}|trim})]
								[(#SET{lon,			 #DESCRIPTIF*|explode{','}|table_valeur{1}|trim})]
								[(#SET{territoire, ''})]
								<BOUCLE_type(MOTS){id_syndic}{id_groupe=2}{0,1}>[
									(#SET{territoire,#TITRE})][
									(#SET{mot_territoire_id,#ID_MOT})
								]</BOUCLE_type>
								[(#SET{type_site, ''})]
								<BOUCLE_terr(MOTS){id_syndic}{id_groupe=4}{0,1}>[
									(#SET{type_site,#TITRE})][
									(#SET{mot_typesite_id,#ID_MOT})
								]</BOUCLE_terr>
								<tr
									[(#STATUT|=={prop}|oui) style="background:hsl(210.98deg 63.89% 82.96%)"]
									[(#STATUT|=={publie}|oui) style="background:hsl(106, 63%, 83%)"]>
									<td style="padding: 0.2em;text-align:right;">[(#GET{type_site}|sinon{???})]</td>
									<th style="padding: 0.2em;text-align:left" title="#NOM_SITE*">[(#NOM_SITE*|coupe{40})]</th>
									<td style="padding: 0.2em;" title="#URL_SITE">[(#URL_SITE|coupe)]</span>
									<td style="padding: 0.2em;">[(#DESCRIPTIF*|trim)]</td>
									<td style="padding: 0.2em;">[(#GET{territoire}|sinon{???})]</td>
									<td style="padding: 0.2em;text-align:center">
										<div style="display:flex; gap:.5em; justify-content:center; align-items: center;">
											[(#AUTORISER{instituer,site,#ID_SYNDIC}|oui)
												<form style="display:contents;"
															action="[(#URL_ACTION_AUTEUR{pub_geolien,#ID_SYNDIC,#SELF})]"
															method="post">
													[(#STATUT|=={prop}|non)
														<button type="submit" name="statut" value="prop">Proposer</button>
													]
													[(#STATUT|=={publie}|non)
														<button type="submit" name="statut" value="publie">Publier</button>
													]
													[(#STATUT|=={refuse}|non)
														<button type="submit" name="statut" value="refuse">Refuser</button>
													]
												</form>
											]
											[(#AUTORISER{modifier,site,#ID_SYNDIC}|oui)
												<button type="button" data-dlg="dlg-site-#ID_SYNDIC">Modifier</button>

												<dialog id="dlg-site-#ID_SYNDIC" style="width: 800px;">
													<form style="display:grid;grid-template-columns: max-content 1fr; gap: 0.5em; align-items: center;"
																action="[(#URL_ACTION_AUTEUR{maj_geolien,#ID_SYNDIC,#SELF})]"
																method="post">
														<label>Type de site</label>
														<select name="typesite_site">
															<option value="">Pas de type !</option>
															<BOUCLE_groupmot_typesite(MOTS){id_groupe=4}{par titre}>
																<option value="#ID_MOT"[(#ID_MOT|=={#GET{mot_typesite_id}}|oui) selected="selected"]>#TITRE</option>
															</BOUCLE_groupmot_typesite>
														</select>

														<label>Nom du site</label>
														<input type="text" name="nom_site" value="#NOM_SITE">

														<label>URL du site</label>
														<input type="url" name="url_site" value="#URL_SITE">

														<label>Territoire</label>
														<select name="territoire_site">
															<option value="">Pas de territoire !</option>
															<BOUCLE_groupmot_territoire(MOTS){id_groupe=2}{par titre}>
																<option value="#ID_MOT"[(#ID_MOT|=={#GET{mot_territoire_id}}|oui) selected="selected"]>#TITRE</option>
															</BOUCLE_groupmot_territoire>
														</select>

														<div class="coords-ui">
															<div class="geo-wrap" style="grid-column: span 2;">
																<!-- Carte à gauche -->
																<div id="map-site-#ID_SYNDIC"
																		class="leaflet-map"
																		data-lat="[(#DESCRIPTIF|textebrut|explode{','}|table_valeur{0}|trim)]"
																		data-lon="[(#DESCRIPTIF|textebrut|explode{','}|table_valeur{1}|trim)]">
																</div>

																<!-- Panneau recherche à droite (lié à la bonne carte via data-map) -->
																<div class="geo-panel" data-map="map-site-#ID_SYNDIC">
																	<div class="geo-searchbar" style="display:flex; gap:.5em; margin-bottom:.5rem">
																		<input class="geo-search" data-map="map-site-#ID_SYNDIC" value="[(#TITRE|attribut_html)]"
																					type="search" placeholder="Rechercher une adresse ou un lieu…" style="flex:1">
																		<!--button class="geo-clear" data-map="map-site-#ID_SYNDIC" type="button" aria-label="Effacer">✖</button-->
																	</div>

																	<div class="geo-results" data-map="map-site-#ID_SYNDIC" hidden></div>

																	<small style="margin-top:.5rem; color:#666">
																		Clique sur la carte, déplace le marqueur ou utilise la recherche.
																	</small>
																</div>
															</div>

															<label>Latitude</label>
															<input type="text" name="lat_site" value="[(#DESCRIPTIF*|explode{','}|table_valeur{0}|trim)]">

															<label>Longitude</label>
															<input type="text" name="long_site" value="[(#DESCRIPTIF*|explode{','}|table_valeur{1}|trim)]">
														</div>

														<!-- pour les bouton on fait un div flex sur les 2 column puis on les met a 50% -->
														<div style="grid-column: span 2; display:flex; gap: 0.5em">
															<button class="close-all-dlg" type="button" value="Annuler" style="flex: 1;">Annuler</button>
															<button type="submit" value="Enregistrer" style="flex: 1;">Enregistrer</button>
														</div>
													</form>
												</dialog>
											]
										</div>
									</td>
								</tr>
							</BOUCLE_sites>
						</tbody>
					</table>
				</B_sites>
				<!-- Sous-rubriques : récursion -->
				<BOUCLE_ssrub(RUBRIQUES){id_parent}{tout}{par num titre, titre}>
					<INCLURE{fond=contenu/edition-geoliens-recursive,id_rubrique=#ID_RUBRIQUE,niveau_rec=#NIVEAU_REC|plus{1}}>
				</BOUCLE_ssrub>
			</div>
		</div>
	</BOUCLE_can>
		<BOUCLE_ssrub_alt(RUBRIQUES){id_parent}{tout}{par num titre, titre}>
			<INCLURE{fond=contenu/edition-geoliens-recursive,id_rubrique=#ID_RUBRIQUE}>
		</BOUCLE_ssrub_alt>
	<//B_can>
</BOUCLE_rub>