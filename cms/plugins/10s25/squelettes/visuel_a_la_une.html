[(#REM) --- LE VISUEL √Ä LA UNE ---]
<head>
    <INCLURE{fond=inclure/static_head}
    {css=/local/visuel_a_la_une.css}>
</head>

<div class="visuel_a_la_une">
    <BOUCLE_visuels(DOCUMENTS)
    {extension IN jpg,png,gif,webp}
    {statut==publie}
    {!par date}>

    #SET{sum,0}
    #SET{n,0}
    <BOUCLE_votes(NOTATIONS){objet=document}{id_objet=#ID_DOCUMENT}>
    #SET{sum,#GET{sum}|plus{#NOTE}}
    #SET{n,#GET{n}|plus{1}}
    </BOUCLE_votes>

    #SET{avg,0}
    [(#GET{n}|>{0}|oui)#SET{avg,#GET{sum}|div{#GET{n}}}]

    <BOUCLE_notepond(NOTATIONS_OBJETS){objet=document}{id_objet=#ID_DOCUMENT}>
    #SET{note_ponderee, #NOTE_PONDEREE}
    </BOUCLE_notepond>

    <BOUCLE_aff(CONDITION){si #GET{n}|>{0}}>
    <div class="visuel-item"
         data-note-ponderee="[(#GET{note_ponderee})]"
         data-votes="[(#GET{n})]">
        <div class="note">
            ‚≠ê [(#GET{note_ponderee}|round{1})]/5 <small>([(#GET{n})] vote[s])</small>
        </div>
        <a href="#URL_DOCUMENT" class="mediabox visuel" rel="visuels" title="[(#TITRE|attribut_html)]">
            <img src="#URL_DOCUMENT" alt="[(#TITRE|attribut_html)]" class="visuel-image">
        </a>
    </div>
    </BOUCLE_aff>

    </BOUCLE_visuels>

    <p class="rien">Aucun visuel not√© pour le moment.</p>
<//B_visuels>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const wrap = document.querySelector('.visuel_a_la_une');
        if (!wrap) return;

        const items = [...wrap.querySelectorAll('.visuel-item')];
        if (items.length === 0) return;

        // ü•á Tri : meilleure note pond√©r√©e, puis plus de votes
        items.sort((a, b) => {
            const noteA = parseFloat(a.dataset.notePonderee || 0);
            const noteB = parseFloat(b.dataset.notePonderee || 0);
            const votesA = parseInt(a.dataset.votes || 0);
            const votesB = parseInt(b.dataset.votes || 0);

            if (noteB !== noteA) return noteB - noteA;
            return votesB - votesA;
        });

        // Garde uniquement la meilleure
        for (let i = 1; i < items.length; i++) items[i].remove();
        wrap.appendChild(items[0]);
    });
</script>

